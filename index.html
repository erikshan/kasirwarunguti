<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Uti Nur - Cloud POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .bar-growth { animation: growUp 1s ease-out forwards; transform-origin: bottom; transform: scaleY(0); }
        @keyframes growUp { to { transform: scaleY(1); } }
        .loading-overlay { background: rgba(255,255,255,0.8); z-index: 50; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- LOGIN VIEW -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md border-t-4 border-blue-600">
            <div class="text-center mb-8">
                <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-100">
                    <i data-lucide="cloud" class="text-blue-600 w-10 h-10"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Toko Uti Nur</h1>
                <p class="text-gray-500 text-sm mt-1">Sistem POS Online</p>
            </div>
            <div id="login-error" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded mb-6 text-sm flex items-center gap-2"></div>
            <form id="login-form" class="space-y-5">
                <div><label class="block text-gray-700 text-sm font-semibold mb-2">Username</label><input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Contoh: owner"></div>
                <div><label class="block text-gray-700 text-sm font-semibold mb-2">Password</label><input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="123"></div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-600/30">Masuk Aplikasi</button>
            </form>
            <div class="mt-8 pt-6 border-t border-gray-100 text-xs text-gray-400 text-center"><p>Data tersimpan aman di Cloud</p></div>
        </div>
    </div>

    <!-- MAIN APP VIEW -->
    <div id="app-view" class="hidden flex h-screen overflow-hidden">
        <aside id="sidebar" class="hidden lg:flex w-72 bg-white border-r border-gray-200 flex-col z-30 transition-transform duration-300 absolute lg:relative h-full">
            <div class="p-6 border-b border-gray-100 flex items-center gap-3 shrink-0">
                <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-600/30"><i data-lucide="shopping-cart" size="24"></i></div>
                <div><h1 class="font-bold text-xl leading-tight text-gray-900">RetailPOS</h1><p class="text-[10px] text-gray-400 font-mono tracking-wide">ONLINE MODE</p></div>
                <button id="close-sidebar" class="lg:hidden ml-auto text-gray-500"><i data-lucide="x"></i></button>
            </div>
            <nav id="nav-menu" class="p-4 space-y-1.5 flex-1 overflow-y-auto"></nav>
            <div class="p-4 border-t border-gray-100 bg-gray-50/50 shrink-0">
                <div class="flex items-center gap-3 mb-4 bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                    <div class="bg-gray-100 rounded-full p-2 text-gray-500"><i data-lucide="user" size="18"></i></div>
                    <div class="overflow-hidden"><p id="user-name-display" class="text-sm font-bold truncate text-gray-800"></p><p id="user-role-display" class="text-[10px] text-gray-500 uppercase tracking-wider font-semibold"></p></div>
                </div>
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 text-red-600 bg-white border border-red-100 hover:bg-red-50 hover:border-red-200 py-2.5 rounded-lg text-sm font-medium transition"><i data-lucide="log-out" size="16"></i> Keluar</button>
            </div>
        </aside>
        <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-50/50 w-full relative">
            <header class="lg:hidden bg-white border-b border-gray-200 p-4 flex justify-between items-center shadow-sm z-10">
                <button onclick="toggleSidebar()" class="p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"><i data-lucide="menu"></i></button>
                <span id="header-title" class="font-bold text-gray-800">Dashboard</span>
                <div class="w-8"></div>
            </header>
            <div id="content-area" class="flex-1 overflow-auto p-4 lg:p-6 relative"></div>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden absolute inset-0 loading-overlay flex items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        </main>
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden backdrop-blur-sm"></div>
    </div>

    <!-- MODALS -->
    <!-- Qty Modal -->
    <div id="qty-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
            <div class="text-center mb-6"><h3 class="text-lg font-bold text-gray-800">Input Jumlah</h3><p id="qty-modal-prod-name" class="text-sm text-blue-600 font-medium"></p><p id="qty-modal-prod-price" class="text-xs text-gray-500"></p></div>
            <input type="hidden" id="qty-modal-prod-id"><input type="hidden" id="qty-modal-base-price">
            <div class="space-y-4">
                <div class="relative"><label class="block text-xs font-bold text-gray-500 mb-1">Beli (Rp)</label><div class="relative"><span class="absolute left-3 top-2.5 text-gray-500 font-bold text-sm">Rp</span><input type="number" id="qty-input-price" oninput="calcQtyFromPrice()" class="w-full pl-10 pr-4 py-3 border-2 border-blue-100 rounded-xl focus:border-blue-500 focus:outline-none text-lg font-bold text-gray-800" placeholder="0"></div></div>
                <div class="flex items-center justify-center text-gray-400 text-xs">- ATAU -</div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Beli Berat (<span id="qty-modal-unit">Kg</span>)</label><input type="number" step="0.01" id="qty-input-weight" oninput="calcPriceFromQty()" class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-blue-500 focus:outline-none text-lg font-bold text-gray-800" placeholder="0.00"></div>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="closeModal('qty-modal')" class="flex-1 py-3 border border-gray-300 rounded-xl font-bold text-gray-600 hover:bg-gray-50 transition">Batal</button><button onclick="confirmCustomItem()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg transition">Masuk Keranjang</button></div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-lg w-full max-w-sm overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="bg-gray-800 p-4 text-white flex justify-between items-center shrink-0"><h3 class="font-bold flex items-center gap-2"><i data-lucide="printer" size="18"></i> Cetak Struk</h3><button onclick="closeModal('receipt-modal')" class="hover:bg-gray-700 p-1 rounded"><i data-lucide="x"></i></button></div>
            <div class="p-6 overflow-y-auto bg-white font-mono text-xs sm:text-sm text-gray-800 space-y-1" id="receipt-area"></div>
            <div class="p-4 bg-gray-50 border-t flex gap-2 shrink-0"><button onclick="window.print()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-sm"><i data-lucide="printer"></i> Cetak</button><button onclick="saveReceiptAsText()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-sm"><i data-lucide="save"></i> TXT</button><button onclick="closeModal('receipt-modal')" class="px-4 border border-gray-300 hover:bg-gray-100 text-gray-700 py-2.5 rounded-lg text-sm font-bold">Tutup</button></div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 max-h-[90vh] overflow-y-auto">
            <h3 id="product-modal-title" class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">Input Produk</h3>
            <form id="product-form" class="space-y-5">
                <input type="hidden" id="prod-id">
                <div class="flex justify-center mb-4"><div class="relative group cursor-pointer" onclick="document.getElementById('prod-file').click()"><img id="prod-preview" src="https://via.placeholder.com/150?text=No+Image" class="w-32 h-32 object-cover rounded-lg border-2 border-dashed border-gray-300 group-hover:border-blue-500"><div class="absolute inset-0 bg-black/40 flex items-center justify-center rounded-lg opacity-0 group-hover:opacity-100 transition text-white font-bold text-xs">Ganti Foto</div></div><input type="file" id="prod-file" accept="image/*" class="hidden" onchange="handleImageUpload(this)"></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">URL Gambar (Opsional)</label><input type="text" id="prod-img-url" oninput="updateImagePreview(this.value)" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none text-xs" placeholder="https://..."></div>
                <div class="grid grid-cols-2 gap-5"><div><label class="block text-sm font-semibold text-gray-700 mb-1">SKU / Barcode</label><input required type="text" id="prod-sku" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none"></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Kategori</label><select required id="prod-category" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"></select></div></div>
                <div><label class="block text-sm font-semibold text-gray-700 mb-1">Nama Produk</label><input required type="text" id="prod-name" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none"></div>
                <div class="grid grid-cols-2 gap-5">
                    <div><label class="block text-sm font-bold text-green-700 mb-1">Harga Beli</label><input required type="number" id="prod-cost" class="w-full border border-green-200 bg-green-50 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="0"></div>
                    <div><label class="block text-sm font-bold text-blue-700 mb-1">Harga Jual</label><input required type="number" id="prod-price" class="w-full border border-blue-200 bg-blue-50 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="0"></div>
                </div>
                <div class="grid grid-cols-2 gap-5"><div><label class="block text-sm font-semibold text-gray-700 mb-1">Satuan</label><select id="prod-unit" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"></select></div><div><label class="block text-sm font-semibold text-gray-700 mb-1">Stok Awal</label><input required type="number" id="prod-stock" class="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none"></div></div>
                <div class="flex gap-3 mt-8 pt-4 border-t"><button type="button" onclick="closeModal('product-modal')" class="flex-1 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium text-gray-700">Batal</button><button type="submit" class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md">Simpan</button></div>
            </form>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ==========================================
        // KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBWkwfiYSg9CRYOtP-u6nrmoUuECevvQ3I",
            authDomain: "kasir-uti-nur.firebaseapp.com",
            projectId: "kasir-uti-nur",
            storageBucket: "kasir-uti-nur.firebasestorage.app",
            messagingSenderId: "1023265298114",
            appId: "1:1023265298114:web:ade27bb322498d91cc0d5b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- CONSTANTS ---
        const ROLES = { OWNER: 'owner', MANAGER: 'manager', CASHIER: 'kasir', WAREHOUSE: 'gudang' };
        const PRODUCT_CATEGORIES = ['Beras', 'Telur', 'Minyak', 'Gula', 'Tepung', 'Makanan', 'Minuman', 'Sembako', 'ATK', 'Rumah Tangga', 'Elektronik', 'Lainnya'];
        const PRODUCT_UNITS = ['Pcs', 'Kg', 'Liter', 'Box', 'Pack', 'Botol', 'Gelas', 'Unit', 'Buah', 'Meter'];
        
        const INITIAL_USERS = [
            { id: 1, username: 'owner', password: '123', role: ROLES.OWNER, name: 'Budi (Owner)' },
            { id: 2, username: 'manager', password: '123', role: ROLES.MANAGER, name: 'Siti (Manager)' },
            { id: 3, username: 'kasir', password: '123', role: ROLES.CASHIER, name: 'Andi (Kasir)' },
            { id: 4, username: 'gudang', password: '123', role: ROLES.WAREHOUSE, name: 'Joko (Gudang)' },
        ];

        // --- GLOBAL STATE ---
        let state = {
            user: null, activeTab: 'dashboard',
            products: [], transactions: [], deletedLogs: [], accounting: [], // Data fetched from Firebase
            cart: [], posSearch: '', reportFilter: { start: '', end: '', showDeleted: false }, peakHourFilter: { start: '' }, lastTrx: null, tempImage: ''
        };

        // --- UTILS ---
        const formatIDR = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val);
        const formatDate = (str) => new Date(str).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        const toggleLoading = (show) => document.getElementById('loading-indicator').classList.toggle('hidden', !show);

        // --- APP INITIALIZATION ---
        function initApp() {
            renderLogin();
            lucide.createIcons();
            subscribeToData();
        }

        // --- FIREBASE LISTENERS (REALTIME SYNC) ---
        function subscribeToData() {
            // Products
            db.collection('products').onSnapshot(snapshot => {
                state.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.user) renderContent();
            });
            // Transactions
            db.collection('transactions').orderBy('date', 'desc').limit(200).onSnapshot(snapshot => {
                state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.user) renderContent();
            });
            // Accounting
            db.collection('accounting').orderBy('date', 'desc').limit(100).onSnapshot(snapshot => {
                state.accounting = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.user) renderContent();
            });
            // Deleted Logs
            db.collection('deletedLogs').orderBy('deletedAt', 'desc').limit(50).onSnapshot(snapshot => {
                state.deletedLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(state.user) renderContent();
            });
        }

        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value; const p = document.getElementById('password').value;
            const user = INITIAL_USERS.find(usr => usr.username === u && usr.password === p);
            if (user) { state.user = user; if (user.role === ROLES.CASHIER) state.activeTab = 'pos'; else if (user.role === ROLES.WAREHOUSE) state.activeTab = 'inventory'; else state.activeTab = 'dashboard'; renderApp(); } 
            else { const err = document.getElementById('login-error'); err.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4"></i> Username/password salah`; err.classList.remove('hidden'); lucide.createIcons(); }
        });

        function handleLogout() { state.user = null; state.cart = []; document.getElementById('login-view').classList.remove('hidden'); document.getElementById('app-view').classList.add('hidden'); }
        function renderLogin() { document.getElementById('login-view').classList.remove('hidden'); document.getElementById('app-view').classList.add('hidden'); }
        function renderApp() { document.getElementById('login-view').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); document.getElementById('user-name-display').innerText = state.user.name; document.getElementById('user-role-display').innerText = state.user.role; renderSidebar(); renderContent(); lucide.createIcons(); }
        function toggleSidebar() { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay'); sb.classList.toggle('hidden'); sb.classList.toggle('flex'); sb.classList.toggle('fixed'); sb.classList.toggle('inset-y-0'); sb.classList.toggle('left-0'); ov.classList.toggle('hidden'); }
        function renderSidebar() { const m = document.getElementById('nav-menu'); const i = [{ id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard', roles: [ROLES.OWNER, ROLES.MANAGER] }, { id: 'pos', label: 'Kasir / POS', icon: 'shopping-cart', roles: [ROLES.OWNER, ROLES.MANAGER, ROLES.CASHIER] }, { id: 'inventory', label: 'Stok Produk', icon: 'package', roles: [ROLES.OWNER, ROLES.MANAGER, ROLES.WAREHOUSE] }, { id: 'reports', label: 'Laporan', icon: 'file-text', roles: [ROLES.OWNER, ROLES.MANAGER] }, { id: 'accounting', label: 'Akuntansi', icon: 'calculator', roles: [ROLES.OWNER, ROLES.MANAGER] }]; m.innerHTML = i.filter(x => x.roles.includes(state.user.role)).map(x => `<button onclick="switchTab('${x.id}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${state.activeTab === x.id ? 'bg-blue-50 text-blue-600 shadow-sm ring-1 ring-blue-100' : 'text-gray-500 hover:bg-gray-50 hover:text-gray-800'}"><i data-lucide="${x.icon}" size="20"></i>${x.label}</button>`).join(''); }
        function switchTab(id) { state.activeTab = id; renderContent(); if(window.innerWidth < 1024) toggleSidebar(); }
        function renderContent() { const c = document.getElementById('content-area'); const t = document.getElementById('header-title'); const m = {dashboard: renderDashboard, pos: renderPOS, inventory: renderInventory, reports: renderReports, accounting: renderAccounting}; t.innerText = state.activeTab.toUpperCase(); if(m[state.activeTab]) m[state.activeTab](c); lucide.createIcons(); }

        // --- DASHBOARD ---
        function renderDashboard(c) {
            const sales = state.transactions.reduce((a, b) => a + b.total, 0);
            const low = state.products.filter(p => p.stock < 10).length;
            const chart = state.transactions.slice(0, 7).map(t => ({ val: t.total, lbl: t.id.slice(-4) })); // simplified
            if (!state.peakHourFilter.start) { const today = new Date(); const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000); state.peakHourFilter.start = lastWeek.toISOString().split('T')[0]; }
            const peakStartDate = new Date(state.peakHourFilter.start); peakStartDate.setHours(0,0,0,0);
            const peakEndDate = new Date(peakStartDate.getTime() + 7 * 24 * 60 * 60 * 1000);
            const hoursDistribution = Array(24).fill(0); let maxHourlyTrx = 0;
            state.transactions.forEach(t => { const d = new Date(t.date); if (d >= peakStartDate && d < peakEndDate) { const h = d.getHours(); hoursDistribution[h]++; if(hoursDistribution[h] > maxHourlyTrx) maxHourlyTrx = hoursDistribution[h]; } });
            
            // Best Sellers
            const productSales = {}; 
            state.transactions.forEach(t => t.cartDetail?.forEach(item => { productSales[item.name] = (productSales[item.name] || 0) + item.qty; }));
            const bestSellers = Object.entries(productSales).sort(([,a], [,b]) => b - a).slice(0, 3);

            c.innerHTML = `
                <div class="space-y-6 animate-fade-in pb-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">${kpi('Total Omzet', formatIDR(sales), 'trending-up', 'blue')}${kpi('Total Transaksi', state.transactions.length, 'file-text', 'emerald')}${kpi('Stok Kritis', low + ' Item', 'alert-triangle', 'red')}${kpi('Total SKU', state.products.length, 'package', 'purple')}</div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><h3 class="text-lg font-bold text-gray-800 mb-6">Aktivitas Penjualan (7 Transaksi Terakhir)</h3><div class="flex items-end justify-between h-48 space-x-4 px-2">${chart.map(d => `<div class="flex-1 bg-blue-100 hover:bg-blue-500 rounded-t transition-all relative group" style="height:${Math.min((d.val/500000)*100, 100)}%"><div class="absolute -top-6 text-xs bg-black text-white px-1 rounded opacity-0 group-hover:opacity-100">${formatIDR(d.val)}</div></div>`).join('')}</div></div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-2"><h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i data-lucide="clock" size="18"></i> Analisis Jam Ramai</h3><div class="flex items-center gap-2 text-sm text-gray-500"><span>Mulai:</span><input type="date" value="${state.peakHourFilter.start}" onchange="state.peakHourFilter.start=this.value; renderContent()" class="border rounded px-2 py-1 text-xs"><span>(+7 Hari)</span></div></div><div class="relative h-48 flex items-end space-x-1 overflow-x-auto pb-6">${hoursDistribution.map((count, hour) => { if (hour < 5 || hour > 21) return ''; const height = maxHourlyTrx > 0 ? (count / maxHourlyTrx) * 100 : 0; const isPeak = count === maxHourlyTrx && maxHourlyTrx > 0; return `<div class="flex-1 flex flex-col items-center min-w-[20px] group relative h-full justify-end"><div class="w-full ${isPeak ? 'bg-red-400' : 'bg-indigo-200'} rounded-t hover:bg-indigo-500 transition-all bar-growth relative" style="height: ${Math.max(height, 5)}%"><span class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-gray-600 opacity-0 group-hover:opacity-100">${count} Trx</span></div><span class="text-[10px] text-gray-400 mt-1 rotate-0">${hour}:00</span></div>`; }).join('')}</div><p class="text-xs text-gray-400 text-center italic">Grafik menampilkan frekuensi transaksi pada jam operasional (05.00 - 21.00).</p></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit"><h3 class="text-lg font-bold text-gray-800 mb-4">Produk Terlaris</h3><div class="space-y-4">${bestSellers.length ? bestSellers.map(([name, qty], idx) => `<div class="flex items-center gap-3 pb-3 border-b last:border-0 border-gray-50"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${idx===0 ? 'bg-yellow-100 text-yellow-700': 'bg-gray-100 text-gray-600'}">${idx + 1}</div><div class="flex-1"><p class="text-sm font-medium text-gray-800 truncate">${name}</p><p class="text-xs text-gray-500">${qty} Terjual</p></div></div>`).join('') : '<p class="text-sm text-gray-400">Belum ada data.</p>'}</div></div>
                    </div>
                </div>`;
        }
        function kpi(t, v, i, c) { return `<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex justify-between"><div><p class="text-gray-500 text-sm">${t}</p><h3 class="text-2xl font-bold text-${c}-600">${v}</h3></div><div class="p-2 bg-${c}-50 rounded-lg text-${c}-600"><i data-lucide="${i}"></i></div></div>`; }

        // --- ACCOUNTING ---
        function renderAccounting(c) {
            const today = new Date().toISOString().split('T')[0];
            const tTrx = state.transactions.filter(t => t.date.startsWith(today));
            const tSales = tTrx.reduce((a,b)=>a+b.total,0);
            const tCOGS = tTrx.reduce((a,b)=>a+(b.totalCost||0),0);
            
            const tIn = state.accounting.filter(a => a.date===today && a.type==='IN').reduce((a,b)=>a+b.amount,0);
            const tOut = state.accounting.filter(a => a.date===today && a.type==='OUT').reduce((a,b)=>a+b.amount,0);
            
            const gross = tSales - tCOGS;
            const net = (gross + tIn) - tOut;

            // Header Cards Totals (All Time)
            const allSales = state.transactions.reduce((a,b)=>a+b.total,0);
            const allIn = state.accounting.filter(a=>a.type==='IN').reduce((a,b)=>a+b.amount,0);
            const allOut = state.accounting.filter(a=>a.type==='OUT').reduce((a,b)=>a+b.amount,0);
            const balance = (allSales + allIn) - allOut;

            c.innerHTML = `
                <div class="space-y-6 pb-10">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Akuntansi</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gradient-to-br from-green-50 to-white p-6 rounded-xl shadow-sm border border-green-100"><p class="text-sm text-green-600 font-bold mb-1">SALDO KAS SAAT INI</p><h3 class="text-2xl font-bold text-gray-800">${formatIDR(balance)}</h3><p class="text-xs text-gray-500 mt-2">Uang fisik tersedia</p></div>
                        <div class="bg-gradient-to-br from-blue-50 to-white p-6 rounded-xl shadow-sm border border-blue-100"><p class="text-sm text-blue-600 font-bold mb-1">LABA BERSIH HARI INI</p><h3 class="text-2xl font-bold text-gray-800">${formatIDR(net)}</h3><p class="text-xs text-gray-500 mt-2">Setelah dikurangi modal & biaya</p></div>
                        <div class="bg-gradient-to-br from-purple-50 to-white p-6 rounded-xl shadow-sm border border-purple-100"><p class="text-sm text-purple-600 font-bold mb-1">PENGELUARAN HARI INI</p><h3 class="text-2xl font-bold text-gray-800">${formatIDR(tOut)}</h3><p class="text-xs text-gray-500 mt-2">Biaya operasional</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="space-y-6">
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="trending-up" size="18"></i> Rincian Laba Hari Ini</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between"><span class="text-gray-500">Omzet Penjualan</span><span class="font-bold text-gray-800">${formatIDR(tSales)}</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">Modal Barang (HPP)</span><span class="font-bold text-red-400">-${formatIDR(tCOGS)}</span></div>
                                    <div class="flex justify-between border-t pt-2"><span class="text-gray-700 font-semibold">Laba Kotor</span><span class="font-bold text-blue-600">${formatIDR(gross)}</span></div>
                                    <div class="flex justify-between mt-2 pt-2 border-t border-dashed"><span class="text-gray-500">Pemasukan Lain</span><span class="font-bold text-green-600">+${formatIDR(tIn)}</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">Biaya Operasional</span><span class="font-bold text-red-600">-${formatIDR(tOut)}</span></div>
                                    <div class="flex justify-between border-t border-gray-800 pt-2 bg-gray-50 p-2 rounded"><span class="font-bold text-gray-900">KEUNTUNGAN BERSIH</span><span class="font-bold ${net>=0?'text-green-600':'text-red-600'}">${formatIDR(net)}</span></div>
                                </div>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="plus-circle" size="18"></i> Catat Keuangan</h3>
                                <form onsubmit="addAcc(event)" class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label class="text-xs font-bold text-gray-500">Tanggal</label><input type="date" id="ac-date" value="${today}" class="w-full border rounded px-3 py-2 text-sm"></div>
                                        <div><label class="text-xs font-bold text-gray-500">Jenis</label><select id="ac-type" class="w-full border rounded px-3 py-2 text-sm" onchange="updAcCat()"><option value="OUT">Pengeluaran</option><option value="IN">Pemasukan</option></select></div>
                                    </div>
                                    <div><label class="text-xs font-bold text-gray-500">Kategori</label><select id="ac-cat" class="w-full border rounded px-3 py-2 text-sm bg-white"></select></div>
                                    <div><label class="text-xs font-bold text-gray-500">Nominal (Rp)</label><input type="number" id="ac-amt" placeholder="0" class="w-full border rounded px-3 py-2 text-sm"></div>
                                    <div><label class="text-xs font-bold text-gray-500">Keterangan</label><input type="text" id="ac-desc" placeholder="Contoh: Listrik" class="w-full border rounded px-3 py-2 text-sm"></div>
                                    <button class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-sm">Simpan</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-[500px]">
                            <div class="p-4 border-b bg-gray-50 font-bold text-gray-700">Riwayat Pencatatan Manual</div>
                            <div class="overflow-y-auto flex-1 p-0">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0"><tr><th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3">Ket</th><th class="px-4 py-3 text-right">Jumlah</th><th class="px-4 py-3 text-center">Aksi</th></tr></thead>
                                    <tbody class="text-sm divide-y divide-gray-100">${state.accounting.slice().reverse().map(a => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 whitespace-nowrap text-gray-500">${formatDate(a.date)}</td><td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${a.type==='IN'?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}">${a.category}</span></td><td class="px-4 py-3 text-gray-700">${a.description}</td><td class="px-4 py-3 text-right font-bold ${a.type==='IN'?'text-green-600':'text-red-600'}">${a.type==='IN'?'+':'-'}${formatIDR(a.amount)}</td><td class="px-4 py-3 text-center"><button onclick="delAcc('${a.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" size="14"></i></button></td></tr>`).join('')}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            updAcCat();
        }
        function updAcCat() {
            const t = document.getElementById('ac-type').value;
            const c = t === 'OUT' ? ['Operasional Toko', 'Gaji Karyawan', 'Listrik & Air', 'Sewa', 'Lainnya'] : ['Modal Tambahan', 'Pendapatan Lain', 'Lainnya'];
            document.getElementById('ac-cat').innerHTML = c.map(x => `<option>${x}</option>`).join('');
        }
        function addAcc(e) { 
            e.preventDefault(); 
            const d = { 
                date: document.getElementById('ac-date').value, 
                type: document.getElementById('ac-type').value, 
                category: document.getElementById('ac-cat').value, 
                amount: Number(document.getElementById('ac-amt').value), 
                description: document.getElementById('ac-desc').value, 
                created: Date.now(),
                user: state.user.name
            };
            db.collection('accounting').add(d);
        }
        function delAcc(id) { if(confirm('Hapus?')) db.collection('accounting').doc(id).delete(); }

        // --- POS ---
        function renderPOS(c) {
            const filtered = state.products.filter(p => p.name.toLowerCase().includes(state.posSearch.toLowerCase()));
            c.innerHTML = `<div class="flex flex-col lg:flex-row h-full gap-4 pb-2"><div class="flex-1 bg-white rounded-xl shadow-sm border p-4 flex flex-col"><div class="mb-4"><input type="text" oninput="state.posSearch=this.value;renderContent()" class="w-full border p-2 rounded" placeholder="Cari..." autofocus></div><div class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-3 content-start">${filtered.map(p => `<div onclick="posAdd('${p.id}')" class="border p-3 rounded hover:border-blue-500 cursor-pointer ${p.stock<=0?'opacity-50':''}"><div class="h-24 bg-gray-100 mb-2 rounded flex items-center justify-center overflow-hidden">${p.image?`<img src="${p.image}" class="w-full h-full object-cover">`:`<i data-lucide="package"></i>`}</div><h4 class="font-bold text-sm truncate">${p.name}</h4><div class="flex justify-between text-xs mt-1"><span class="text-blue-600 font-bold">${formatIDR(p.price)}</span><span>Stok: ${parseFloat(p.stock).toFixed(1)} ${p.unit}</span></div></div>`).join('')}</div></div><div class="w-full lg:w-96 bg-white rounded-xl shadow-lg flex flex-col border"><div class="p-4 border-b font-bold">Keranjang</div><div class="flex-1 overflow-y-auto p-4 space-y-2">${state.cart.map(i => `<div class="flex justify-between items-center text-sm border-b pb-2"><div><div class="font-bold">${i.name}</div><div class="text-xs text-gray-500">${parseFloat(i.qty).toFixed(2)} ${i.unit} x ${formatIDR(i.price)}</div></div><div class="flex items-center gap-2"><div class="font-bold">${formatIDR(Math.round(i.qty*i.price))}</div><button onclick="posRem('${i.id}')" class="text-red-500"><i data-lucide="trash-2" size="14"></i></button></div></div>`).join('')}</div><div class="p-4 bg-gray-50 border-t" id="pos-checkout-area"></div></div></div>`;
            renderPOSCheckout();
        }
        function renderPOSCheckout() {
            const el = document.getElementById('pos-checkout-area'); if(!el) return;
            const sub = Math.round(state.cart.reduce((a,b)=>a+(b.price*b.qty),0));
            if(typeof state.posDiscount === 'undefined') state.posDiscount = 0;
            if(typeof state.posMethod === 'undefined') state.posMethod = 'CASH';
            if(typeof state.posCash === 'undefined') state.posCash = '';
            const tot = Math.max(0, sub - state.posDiscount);
            const chg = state.posMethod === 'CASH' ? (parseInt(state.posCash)||0) - tot : 0;
            
            el.innerHTML = `<div class="space-y-3"><div class="flex justify-between font-bold text-lg"><span>Total</span><span>${formatIDR(tot)}</span></div><div class="flex gap-2 items-center"><span class="text-xs w-12">Disc</span><input type="number" oninput="state.posDiscount=Number(this.value);renderPOSCheckout()" value="${state.posDiscount||''}" class="border p-1 w-full text-right rounded"></div><div class="grid grid-cols-3 gap-1 text-xs font-bold">${['CASH','QRIS','DEBIT'].map(m=>`<button onclick="state.posMethod='${m}';renderPOSCheckout()" class="p-2 border rounded ${state.posMethod===m?'bg-blue-600 text-white':''}">${m}</button>`).join('')}</div>${state.posMethod==='CASH'?`<div class="space-y-1"><div class="grid grid-cols-3 gap-2 mb-2"><button onclick="state.posCash=${tot};renderPOSCheckout()" class="py-1 px-2 bg-green-50 text-green-700 border border-green-200 rounded text-[10px] font-bold hover:bg-green-100">Uang Pas</button>${[10000, 20000, 50000, 100000].map(amt => `<button onclick="state.posCash=${amt};renderPOSCheckout()" class="py-1 px-2 bg-gray-50 text-gray-700 border border-gray-200 rounded text-[10px] font-medium hover:bg-gray-100">${amt/1000}k</button>`).join('')}</div><input type="number" oninput="state.posCash=this.value;renderPOSCheckout()" value="${state.posCash}" class="w-full border p-2 rounded" placeholder="Bayar..."><div class="flex justify-between text-xs font-bold ${chg<0?'text-red-500':'text-green-600'}"><span>Kembali</span><span>${formatIDR(chg)}</span></div></div>`:''}<button onclick="posPay()" ${!state.cart.length?'disabled':''} class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700 disabled:bg-gray-300">Bayar</button></div>`;
        }
        function posAdd(id) { const p = state.products.find(x => x.id === id); if(p.stock<=0) return alert('Habis'); if(p.unit==='Kg'||p.unit==='Liter'||p.category==='Telur') { openQty(p); return; } const ex = state.cart.find(x => x.id === id); if(ex){ if(ex.qty>=p.stock) return alert('Stok kurang'); ex.qty++; } else state.cart.push({...p, qty:1}); renderContent(); }
        function posRem(id) { state.cart = state.cart.filter(x => x.id !== id); renderContent(); }
        function posPay() {
            if(!state.cart.length) return;
            toggleLoading(true);
            const total = Math.round(state.cart.reduce((a,b) => a+(b.price*b.qty), 0));
            const cost = state.cart.reduce((a,b) => a+((b.cost||0)*b.qty), 0);
            const cash = parseInt(state.posCash) || 0;
            const disc = state.posDiscount || 0;
            const finalTotal = Math.max(0, total - disc);

            if(state.posMethod === 'CASH' && cash < finalTotal) { toggleLoading(false); return alert('Uang kurang!'); }

            const trx = { 
                id: `TRX-${Date.now().toString().slice(-5)}`, 
                date: new Date().toISOString(), 
                subtotal: total, discount: disc, total: finalTotal, totalCost: cost,
                cartDetail: state.cart, cashier: state.user.name, 
                paymentMethod: state.posMethod, cashReceived: cash, change: cash - finalTotal
            };
            
            const batch = db.batch();
            const trxRef = db.collection('transactions').doc();
            batch.set(trxRef, trx);
            state.cart.forEach(item => {
                const prodRef = db.collection('products').doc(item.id);
                // Simple stock deduction logic, in real app handle concurrency
                const newStock = Math.max(0, item.stock - item.qty);
                batch.update(prodRef, { stock: newStock });
            });

            batch.commit().then(() => {
                toggleLoading(false);
                state.cart = []; state.posDiscount=0; state.posCash='';
                state.lastTrx = { ...trx, id: trx.id }; // for receipt
                renderContent();
                showReceiptModal(state.lastTrx);
            }).catch(err => {
                toggleLoading(false);
                alert('Gagal transaksi: ' + err.message);
            });
        }

        // --- INVENTORY ---
        function renderInventory(c) {
            c.innerHTML = `<div class="space-y-4 pb-10"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold">Stok Produk</h2><button onclick="openProdModal()" class="bg-blue-600 text-white px-4 py-2 rounded flex gap-2"><i data-lucide="plus"></i> Tambah</button></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr><th class="p-3">Nama</th><th class="p-3">Kategori</th><th class="p-3">Beli / Jual</th><th class="p-3">Stok</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody class="divide-y">${state.products.map(p => `<tr><td class="p-3 font-medium">${p.name}</td><td class="p-3">${p.category}</td><td class="p-3 text-xs"><div>Beli: ${formatIDR(p.cost||0)}</div><div class="text-blue-600 font-bold">Jual: ${formatIDR(p.price)}</div></td><td class="p-3 font-bold ${p.stock<10?'text-red-500':'text-green-600'}">${parseFloat(p.stock).toFixed(2)} ${p.unit}</td><td class="p-3 text-right"><button onclick="openProdModal('${p.id}')" class="text-blue-500 mr-2"><i data-lucide="edit" size="16"></i></button><button onclick="delProd('${p.id}')" class="text-red-500"><i data-lucide="trash-2" size="16"></i></button></td></tr>`).join('')}</tbody></table></div></div>`;
        }
        function openProdModal(id=null) { 
            const m = document.getElementById('product-modal'); 
            state.tempImage = ''; document.getElementById('product-form').reset(); document.getElementById('prod-id').value = '';
            document.getElementById('prod-category').innerHTML = PRODUCT_CATEGORIES.map(c => `<option>${c}</option>`).join('');
            document.getElementById('prod-unit').innerHTML = PRODUCT_UNITS.map(u => `<option>${u}</option>`).join('');
            
            if(id) {
                const p = state.products.find(x => x.id === id);
                document.getElementById('product-modal-title').innerText = 'Edit Produk';
                document.getElementById('prod-id').value = p.id;
                document.getElementById('prod-sku').value = p.sku;
                document.getElementById('prod-name').value = p.name;
                document.getElementById('prod-category').value = p.category;
                document.getElementById('prod-unit').value = p.unit;
                document.getElementById('prod-price').value = p.price;
                document.getElementById('prod-cost').value = p.cost || 0;
                document.getElementById('prod-stock').value = p.stock;
                document.getElementById('prod-img-url').value = p.image || '';
                updateImagePreview(p.image);
            } else {
                document.getElementById('product-modal-title').innerText = 'Input Produk';
                updateImagePreview('');
            }
            m.classList.remove('hidden'); 
        }
        function handleImageUpload(i) { const f=i.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{state.tempImage=e.target.result; updateImagePreview(state.tempImage)}; r.readAsDataURL(f); } }
        function updateImagePreview(s) { document.getElementById('prod-preview').src = s || 'https://via.placeholder.com/150?text=No+Image'; }
        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const data = {
                sku: document.getElementById('prod-sku').value, name: document.getElementById('prod-name').value, category: document.getElementById('prod-category').value,
                unit: document.getElementById('prod-unit').value, price: Number(document.getElementById('prod-price').value), cost: Number(document.getElementById('prod-cost').value),
                stock: Number(document.getElementById('prod-stock').value), image: state.tempImage || document.getElementById('prod-img-url').value
            };
            
            if(id) {
                // Keep old image if not updated
                if(!data.image) { const old = state.products.find(x => x.id === id); data.image = old.image; }
                db.collection('products').doc(id).update(data).then(() => closeModal('product-modal'));
            } else {
                db.collection('products').add(data).then(() => closeModal('product-modal'));
            }
        });
        function delProd(id) { if(confirm('Hapus?')) db.collection('products').doc(id).delete(); }

        // --- REPORTS ---
        function renderReports(c) {
            c.innerHTML = `<div class="bg-white rounded p-4"><h2 class="text-xl font-bold mb-4">Laporan Transaksi</h2><div class="overflow-auto max-h-96"><table class="w-full text-sm text-left"><thead class="border-b bg-gray-50"><tr><th class="p-2">ID</th><th class="p-2">Tanggal</th><th class="p-2">Total</th><th class="p-2 text-right">Aksi</th></tr></thead><tbody>${state.transactions.map(t => `<tr><td class="p-2 font-mono text-blue-600">${t.id}</td><td class="p-2">${formatDate(t.date)}</td><td class="p-2 font-bold">${formatIDR(t.total)}</td><td class="p-2 text-right"><button onclick="delTrx('${t.id}')" class="text-red-500"><i data-lucide="trash-2" size="14"></i></button></td></tr>`).join('')}</tbody></table></div></div>`;
        }
        function delTrx(id) { 
            if(confirm('Hapus?')) {
                const t = state.transactions.find(x => x.id === id);
                db.collection('deletedLogs').add({ ...t, deletedAt: new Date().toISOString(), deletedBy: state.user.name });
                db.collection('transactions').doc(id).delete();
            }
        }

        // --- MODALS & HELPERS ---
        function openQty(p) { document.getElementById('qty-modal').classList.remove('hidden'); document.getElementById('qty-modal-prod-id').value = p.id; document.getElementById('qty-modal-base-price').value = p.price; document.getElementById('qty-modal-unit').innerText = p.unit; document.getElementById('qty-modal-prod-name').innerText = p.name; document.getElementById('qty-modal-prod-price').innerText = `${formatIDR(p.price)} / ${p.unit}`; }
        function calcQtyFromPrice() { const p = Number(document.getElementById('qty-input-price').value), b = Number(document.getElementById('qty-modal-base-price').value); if(b>0) document.getElementById('qty-input-weight').value = (p/b).toFixed(3); }
        function calcPriceFromQty() { const w = Number(document.getElementById('qty-input-weight').value), b = Number(document.getElementById('qty-modal-base-price').value); document.getElementById('qty-input-price').value = Math.round(w*b); }
        function confirmCustomItem() { const id = document.getElementById('qty-modal-prod-id').value, qty = Number(document.getElementById('qty-input-weight').value); const p = state.products.find(x => x.id === id); state.cart.push({ ...p, qty }); closeModal('qty-modal'); renderContent(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showReceiptModal(trx) { /* Simplified receipt logic */ document.getElementById('receipt-area').innerHTML = `<div class="text-center font-bold">TOKO UTI NUR</div><div class="text-center text-xs text-gray-500 mb-2">${formatDate(trx.date)} | ${trx.id}</div><hr class="my-2"><div class="text-sm">${trx.cartDetail.map(x=>`<div>${x.name}<br>${parseFloat(x.qty).toFixed(2)} x ${formatIDR(x.price)} = ${formatIDR(Math.round(x.price*x.qty))}</div>`).join('')}</div><hr class="my-2"><div class="flex justify-between font-bold"><span>TOTAL</span><span>${formatIDR(trx.total)}</span></div><div class="text-center mt-4 text-xs">Terima Kasih</div>`; document.getElementById('receipt-modal').classList.remove('hidden'); }
        function saveReceiptAsText() { alert("Fitur simpan TXT aktif."); } // Placeholder

        initApp();
    </script>
</body>
</html>
